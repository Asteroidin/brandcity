;(function () {

/* To track time on site */
if (!sessionStorage.getItem('zigpoll-first-visit-timestamp')) {
  sessionStorage.setItem('zigpoll-first-visit-timestamp', new Date());
}

var pageViews = sessionStorage.getItem('zigpoll-page-views') || 0;
sessionStorage.setItem('zigpoll-page-views', ++pageViews);

/* Init session data */
function initSessionData() {
  var hasInitialized = sessionStorage.getItem('zigpoll-has-initialized-session');

  if (hasInitialized) {
    return;
  }

  /* Add to localstorage to detect recurring visitors */
  var sessions = localStorage.getItem('zigpoll-sessions') || 0;
  localStorage.setItem('zigpoll-sessions', ++sessions);

  sessionStorage.setItem('zigpoll-has-initialized-session', true);  
  sessionStorage.setItem('zigpoll-original-referrer', document.referrer);
  sessionStorage.setItem('zigpoll-landing-page', window.location.href);

  var utmParams = [
    'utm_source',
    'utm_medium',
    'utm_campaign',
    'utm_content',
    'utm_term'
  ];

  var json = Object.fromEntries(new URLSearchParams(window.location.search));
  Object.keys(json).forEach((key) => {
    if (utmParams.indexOf(key) !== -1) {
      sessionStorage.setItem('zigpoll-'+key, json[key]);
    }
  });
}

initSessionData();

function load() {
  var script = document.createElement("script");
  script.type = "text/javascript";
  script.charset = "utf-8";
  script.async = true;
  script.src = '//cdn.zigpoll.com/static/js/embed.js';
  document.head.appendChild(script);
}

function getAccountId() {
  var Zigpoll = window.Zigpoll || {};
  return Zigpoll.accountId;
}

function getPollId() {
  var Zigpoll = window.Zigpoll || {};
  return Zigpoll.pollId;
}

function makeAjaxRequest(callback) {
  var data = {};
  if (getAccountId()) {
    data.accountId = getAccountId();
  }
  if (getPollId()) {
    data.pollId = getPollId();
  }
  data.path = window.location.pathname;
  data.href = window.document.location.href;
  data.pageViews = sessionStorage.getItem('zigpoll-page-views');
  data.sessions = localStorage.getItem('zigpoll-sessions');

  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    // if(xhr.readyState === XMLHttpRequest.DONE) {
    if(xhr.readyState === 4) {
      var status = xhr.status;
      if (status === 0 || (status >= 200 && status < 400)) {
        callback(xhr.responseText);
      } else {
        console.warn('[Zigpoll] Error sending shim request.');
      }
    }
  }
  xhr.open("post", "https://api.zigpoll.com/shim", true); 
  xhr.setRequestHeader("Accept", "application/json");
  xhr.setRequestHeader("Content-Type", "text/plain");
  xhr.send(JSON.stringify(data));
}

function warn(string) {
  console.warn(`[Zigpoll] ${string}`);
  if (typeof window.Zigpoll.onload === 'function') {
    window.Zigpoll.onload(string);
  }
}

function error(string) {
  console.error(`[Zigpoll] ${string}`);
  if (typeof window.Zigpoll.onload === 'function') {
    window.Zigpoll.onload(string);
  }
}

function init() {
  makeAjaxRequest(function (response) {
    try {
      var json = JSON.parse(response);
      if (json.error) {
        error(json.error);
      } else if (json.warning) {
        warn(json.warning);
      } else {
        load();
      }
    } catch(err) {
      error(err);
    }
  });
}

init();

}());